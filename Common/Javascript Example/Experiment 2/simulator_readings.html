<!DOCTYPE html>
<html>
	<head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="popupquestions.js"></script>
        <title>VLabs Physics Exp-2: Diffraction Grating</title>
        <style>
            button{
                position: relative;
                text-align: center;
                width: 180px;
                height: 36px;
                max-width: 40%;
                background: blue;
                color: white;
                font-size: 14px;
                transition: 0.2s;
            }
            select{
                position: relative;
                text-align: center;
                width: 270px;
                height: 36px;
                max-width: 100%;
                -webkit-appearance: none;
                -moz-appearance: none;
                text-indent: 1px;
                text-overflow: '';
                background: blue;
                color: white;
                font-size: 14px;
                transition: 0.2s;
            }
            select:hover, button:hover{
                background: #0f0;
            }
            button, select{
                border: none;
                border-radius:5px;
                margin: 1px auto;
            }
            .switchButton{
                background: #000;
                color: #fff;
            }
            head, body{
                position: relative;
                text-align: center;
                width: 100%;
                height:100vh;
                margin: 0 auto;
            }
            #mainCanvas, #readingCanvas{
                border:1px solid;
            }
            .rangeInputContainer{
                position: relative;
                text-align: center;
                width: 80;
                padding: 5%;
                margin: 0 auto;
            }
            .rangeInput{
                position: relative;
                text-align: center;
                width: 80%;
                background: #00f;
                -webkit-appearance: none;  /* Override default CSS styles */
                appearance: none;
                width: 80%; /* Full-width */
                background: #aaa; /* Grey background */
                border-radius: 5px;
                outline: none; /* Remove outline */
                opacity: 0.7; /* Set transparency (for mouse-over effects on hover) */
                -webkit-transition: .2s; /* 0.2 seconds transition on hover */
                transition: opacity .2s;
            }
            .rangeInput::-webkit-slider-thumb {
                -webkit-appearance: none; /* Override default look */
                appearance: none;
                width: 25px; /* Set a specific slider handle width */
                height: 25px; /* Slider handle height */
                background: #00f; /* Green background */
                cursor: pointer; /* Cursor on hover */
            }
            .rangeInput::-moz-range-thumb {
                width: 25px; /* Set a specific slider handle width */
                height: 25px; /* Slider handle height */
                background: #00f; /* Green background */
                cursor: pointer; /* Cursor on hover */
            }
            .rangeInput:hover .rangeInput::-webkit-slider-thumb{
                background: #0f0;
            }
            .rangeInput:hover .rangeInput::-moz-range-thumb{
                background: #0f0;
            }
            .graphmovementbutton{
                width: 20%;
            }
            .canvascontainer{
                position: relative;
                text-align: center;
                width: 100%;
                height: 65%;
            }
            .controlpanel{
                position: relative;
                text-align: center;
                width: 100%;
                height: 34%;
                padding: 1% auto;
                margin-top: 5px;
            }
            .elementheader{
                position: relative;
                text-align: center;
                width: 100%;
                font-size: 20px;
                font-weight: 600;
                padding: 5px;
            }
            .controlelements{
                position: relative;
                text-align: center;
                width: 24%;
                height: 95%;
                border-radius:5px;
                border: 1px solid;
                overflow: hidden;
                display: inline-block;
                transition: 0.5s;
            }
            .controlelements:hover{
                border-color: #f00;
            }
            .preslide{
                position: fixed;
                text-align: center;
                width: 100%;
            }
            input{
                border: 1px solid;
                border-radius: 5px;
                padding: 6px;
                margin: 1px;
            }
            #readingsData{
                position: relative;
                text-align: center;
                width: 100%;
            }
        </style>
	</head>
	<body>
        <div class="preslide">
            
        </div>
        <div class="container">
            
        </div>
        <div class="canvascontainer">
            <canvas id="mainCanvas"></canvas>
            <canvas id="readingCanvas"></canvas>
        </div>
        <div class="controlpanel">
            <div class="gratingcontrols controlelements">
                <div class="elementheader">Grating Panel</div>
                <button onclick="changeGratingPosition(-10);">Left</button>
                <button onclick="changeGratingPosition(10);">Right</button><br>
                <button onclick="changeGratingPosition(-1);">Fine Left</button>
                <button onclick="changeGratingPosition(1);">Fine Right</button><br>
                <select id="numberOfLines" class="customSelect" onchange="numberOfLinesChanged();">
                    <option value=0>Select Number of lines</option>
                    <option value=2500>2500</option>
                    <option value=5500>5500</option>
                    <option value=10000>10000</option>
                    <option value=15000>15000</option>
                    <option value=10000000000>1000000000</option>
                </select><br>
                <button id="laserButton" class="switchButton" onclick="laserButtonClicked();">Laser Switch</button>
            </div>
            <div class="gratingdetails controlelements">
                <div class="elementheader">Graph Panel</div>
                <button onclick="refreshView();">Refresh View</button>
                <button onclick="resetView();">Reset View</button><br>
                Graph Scale(cm)
                <div class="rangeInputContainer">
                    <input type="range" class="rangeInput" id="pixelRatio" oninput="pixelRatioChanged();" min="1" max="100">
                </div>
                <button class="graphmovementbutton" onclick="graphMovementButtonClicked(-1, 0);">&larr;</button>
                <button class="graphmovementbutton" onclick="graphMovementButtonClicked(1, 0);">&rarr;</button>
                <button class="graphmovementbutton" onclick="graphMovementButtonClicked(0, 1);">&uarr;</button>
                <button class="graphmovementbutton" onclick="graphMovementButtonClicked(0, -1);">&darr;</button>
            </div>
            <div class="readingsection controlelements">
                <div class="elementheader">Readings Panel</div>
                <button id="takeReadingsButton" onclick="showReadingsForm();">Take Readings</button>
                <div id="readingForm" style="display: none;">
                    <input id="pointNumber" readonly><br>
                    Distance Between<br>
                    <input id="pointX" placeholder="Grating & Screen"><br>
                    <input id="pointY" placeholder="Central Spot & nth Point"><br>
                    <button onclick="pointReadingsChanged();">Next</button>
                </div>
            </div>
        </div>
        <div id="readingsData"></div>
        <img id="img_laser" src="images/svg/laser.svg" style="display:none;">
        <img id="img_grating" src="Images/svg/grating.svg" style="display: none;">
        <img id="img_screen" src="Images/svg/screen.svg" style="display: none;">
        <script>
            var gcanvas, readings, popupquestions;
            class Readings{
                constructor(){
                    this.adjacentDistance = [];
                    this.tanTheta = [];
                    this.theta = [];
                    this.calculatedWavelength = [];
                    this.nLambdaN = [];
                    this.currentIndex = 0;
                    this.numberOfLines = 0;
                    this.actualWaveLength = 0;
                    this.pointNumber = this.currentIndex + 1;
                }
                getpointNumber(){
                    return this.pointNumber;
                }
                setNewReadings(reading){
                    this.pointNumber++;
                    this.currentIndex++;
                    this.adjacentDistance.push(reading);
                    if(this.currentIndex < 3){
                        return false;
                    }
                    return true;
                }
                calculateResult(numberOfLines, actualWavelength){
                    for(var i = 0; i < this.currentIndex; i++){
                        this.tanTheta[i] = this.adjacentDistance[i][1] / this.adjacentDistance[i][0];
                        this.theta[i] = Math.atan(this.tanTheta[i]);
                        this.numberOfLines = numberOfLines;
                        this.nLambdaN[i] = Math.sin(this.theta[i]);
                        this.calculatedWavelength[i] = this.nLambdaN[i] / ((i+1)*numberOfLines);
                        this.actualWaveLength = actualWavelength;
                    }
                    this.storeAllData();
                }
                storeAllData(){
                    var adjacentDistanceString = this.adjacentDistance.toString();
                    var tanThetaString = this.tanTheta.toString();
                    var thetaString = this.theta.toString();
                    var calculatedWavelengthString = this.calculatedWavelength.toString();
                    var nLambdaNString = this.nLambdaN.toString();
                    var numberOfLines = this.numberOfLines;
                    var actualWavelength = this.actualWaveLength;
                    
                    localStorage.setItem("adjacentDistance", adjacentDistanceString);
                    localStorage.setItem("tanTheta", tanThetaString);
                    localStorage.setItem("theta", thetaString);
                    localStorage.setItem("calculatedWavelength", calculatedWavelengthString);
                    localStorage.setItem("nLambdaN", nLambdaNString);
                    localStorage.setItem("numberOfLines", numberOfLines);
                    localStorage.setItem("actualWavelength", actualWavelength);
                }
            }
            class Laser{
                constructor(laserelem, wavelength){
                    this.laserelem = laserelem;
                    this.x_co = 0;
                    this.y_co = 0;
                    this.x_orig = 0;
                    this.y_orig = 0;
                    this.laserturnedon = false;
                    this.wavelength = wavelength;
                }
                setOrigin(x_orig, y_orig){
                    this.x_orig = x_orig;
                    this.y_orig = y_orig;
                }
                setOriginWithReset(x_orig, y_orig){
                    this.x_orig = x_orig;
                    this.y_orig = y_orig;
                    this.x_co = x_orig;
                    this.y_co = y_orig;
                }
                flipLaserState(){
                    this.laserturnedon = !this.laserturnedon;
                }
                getLaserState(){
                    return this.laserturnedon;
                }
                moveLaser(coordinates){
                    this.x_co = this.x_co + coordinates[0];
                    this.y_co = this.y_co + coordinates[1];
                }
                point(myCanvas, pgrating, pscreen, pixelRatio){
                    if(this.getLaserState()){
                        var context = myCanvas.getContext("2d");
                        var laserco = this.getCenter();
                        var gratingco = pgrating.getCenter();
                        var screenco = pscreen.getCenter();
                        context.beginPath();
                        context.lineWidth = 6;
                        context.moveTo(laserco[0], laserco[1]);
                        context.lineTo(gratingco[0], gratingco[1]);
                        context.strokeStyle = "red";
                        context.stroke();
                        context.beginPath();
                        context.lineWidth = 1;
                        context.moveTo(gratingco[0], gratingco[1]);
                        context.lineTo(screenco[0], screenco[1]);
                        context.strokeStyle = "red";
                        context.stroke();
                        if(pgrating.getNumberOfLines() > 0){
                            context.lineWidth = 1;
                            var N = pgrating.getNumberOfLines();
                            var lambda = this.wavelength;
                            var angle = N * lambda * Math.pow(10, -8);
                            var x = (screenco[0] - gratingco[0]) / pixelRatio;
                            for(var n = 1; n < 100; n++){
                                var N = pgrating.getNumberOfLines();
                                var arcAngle = n * angle;
                                if(arcAngle > 1 || arcAngle < -1){
                                    break;
                                }
                                var arcInverseSine = Math.asin(arcAngle);
                                var aisTan = Math.tan(arcInverseSine);
                                var y = aisTan * x * pixelRatio;
                                context.beginPath();
                                context.moveTo(gratingco[0], gratingco[1]);
                                context.lineTo(screenco[0], screenco[1] - y);
                                context.stroke();
                                context.beginPath();
                                context.moveTo(gratingco[0], gratingco[1]);
                                context.lineTo(screenco[0], screenco[1] + y);
                                context.stroke();
                                
                            }
                        }
                    }
                }
                getCenter(){
                    var x = Math.floor(this.laserelem.width / 2) + this.getX();
                    var y = Math.floor(this.laserelem.height / 2) + this.getY();
                    return [x, y];
                }
                getX(){
                    return this.x_co;
                }
                getY(){
                    return this.y_co;
                }
                getWavelength(){
                    return this.wavelength;
                }
                getImage(){
                    return this.laserelem;
                }
                resetPosition(){
                    this.x_co = this.x_orig;
                    this.y_co = this.y_orig;
                }
            }
            //This Grating class contains all the Grating related functions such as movement functions, control functions.
            //Variables: grating x, y coordinates, origin x and y, numberOfLines on grating.
            //Functions: setOrigin, setOriginWithReset, moveGrating, setNumberOfLines, getNumberOfLines, getCenter, getX, getY, getImage, resetPosition.
            class Grating{
                constructor(gratingelem){
                    this.gratingelem = gratingelem;
                    this.x_co = 0;
                    this.y_co = 0;
                    this.x_orig = 0;
                    this.y_orig = 0;
                    this.numberOfLines = 0;
                }
                setOrigin(x_orig, y_orig){
                    this.x_orig = x_orig;
                    this.y_orig = y_orig;
                }
                setOriginWithReset(x_orig, y_orig){
                    this.x_orig = x_orig;
                    this.y_orig = y_orig;
                    this.x_co = x_orig;
                    this.y_co = y_orig;
                }
                moveGrating(coordinates){
                    this.x_co = this.x_co + coordinates[0];
                    this.y_co = this.y_co + coordinates[1];
                }
                setNumberOfLines(numberOfLines){
                    if(numberOfLines < 10000000){
                        this.numberOfLines = numberOfLines;
                        return true;
                    }else{
                        alert("X-Rays will need these many rulings to show appreciable diffraction. It is practically not possible to have these many rulings on a grating surface.");
                        return false;
                    }
                }
                getNumberOfLines(){
                    return this.numberOfLines;
                }
                getCenter(){
                    var x = Math.floor(this.gratingelem.width / 2) + this.getX();
                    var y = Math.floor(this.gratingelem.height / 2) + this.getY();
                    return [x, y];
                }
                getX(){
                    return this.x_co;
                }
                getY(){
                    return this.y_co;
                }
                getImage(){
                    return this.gratingelem;
                }
                resetPosition(){
                    this.x_co = this.x_orig;
                    this.y_co = this.y_orig;
                }
			}
            //This Screen class contains all the Screen related functions such as movement functions, control functions.
            //Variables: screen x, y coordinates, origin x and y
            //Functions: setOrigin, setOriginWithReset, moveScreen, getCenter, getX, getY, getImage, resetPosition.
            class Screen{
                constructor(screenelem){
                    this.screenelem = screenelem;
                    this.x_co = 0;
                    this.y_co = 0;
                    this.x_orig = 0;
                    this.y_orig = 0;
                }
                setOrigin(x_orig, y_orig){
                    this.x_orig = x_orig;
                    this.y_orig = y_orig;
                    this.x_co = x_orig;
                    this.y_co = y_orig;
                }
                setOriginWithReset(x_orig, y_orig){
                    this.x_orig = x_orig;
                    this.y_orig = y_orig;
                    this.x_co = x_orig;
                    this.y_co = y_orig;
                }
                moveScreen(coordinates){
                    this.x_co = this.x_co + coordinates[0];
                    this.y_co = this.y_co + coordinates[1];
                }
                getCenter(){
                    var x = Math.floor(this.screenelem.width / 2) + this.getX();
                    var y = Math.floor(this.screenelem.height / 2) + this.getY();
                    return [x, y];
                }
                getX(){
                    return this.x_co;
                }
                getOrigX(){
                    return this.x_orig;
                }
                getOrigY(){
                    return this.y_orig;
                }
                getY(){
                    return this.y_co;
                }
                getImage(){
                    return this.screenelem;
                }
                resetPosition(){
                    this.x_co = this.x_orig;
                    this.y_co = this.y_orig;
                }
            }
            //This Canvas class contains all the Canvas Elements related functions such as movement functions, control functions,.
            //Variables: canvas element, canvas name, laser grating screen objects, canvas pixel ratio(1cm = pixelRatio);
            //Functions: setOriginForAll, moveElements, getCanvas getLaser getGrating getScreen, getCanvasContext, refreshCanvas, resetView.
            class Canvas{
                constructor(canvas, canvasId, laser, grating, screen, width, height, pixelRatio, readingCanvas){
                    this.canvas = canvas;
                    this.canvasId = canvasId;
                    this.laser = laser;
                    this.grating = grating;
                    this.screen = screen;
                    this.canvas.width = Math.floor(window.innerWidth * width * 0.98);
                    this.canvas.height = Math.floor(window.innerHeight * height * 0.98);
                    this.pixelRatio = pixelRatio;
                    this.readingCanvas = readingCanvas;
                    this.fontSize = pixelRatio * 0.6;
                    this.setOriginForAll();
                }
                setOriginForAll(){
                    var totalwidth = this.canvas.width;
                    var totalheight = this.canvas.height;
                    var obj_x = 0;
                    var obj_y = Math.floor((totalheight - this.laser.laserelem.height) / 2);
                    this.laser.setOriginWithReset(obj_x, obj_y);
                    obj_x = Math.floor((totalwidth - this.grating.gratingelem.width) / 2);
                    obj_y = Math.floor((totalheight - this.grating.gratingelem.height) / 2);
                    this.grating.setOriginWithReset(obj_x, obj_y);
                    obj_x = Math.floor(totalwidth - this.screen.screenelem.width);
                    obj_y = Math.floor((totalheight - this.screen.screenelem.height) / 2);
                    this.screen.setOriginWithReset(obj_x, obj_y);
                }
                moveElements(laserco, gratingco, screenco){
                    if((this.laser.getX() + laserco[0] > 0) && (this.laser.getX() + laserco[0] < this.grating.getX())){
                        this.laser.moveLaser(laserco);
                    }
                    if((this.grating.getX() + gratingco[0] > (this.laser.getX() + this.laser.laserelem.width)) && (this.grating.getX() + gratingco[0] < (this.screen.getX() - this.grating.gratingelem.width))){
                        this.grating.moveGrating(gratingco);
                    }
                    if((this.screen.getX() + screenco[0] > (this.grating.getX() + this.grating.gratingelem.width)) && (this.screen.getX() + screenco[0] < this.screen.getOrigX())){
                        this.screen.moveScreen(screenco);
                    }
                    this.refreshCanvas();
                }
                getCanvas(){
                    return this.canvas;
                }
                getLaser(){
                    return this.laser;
                }
                getGrating(){
                    return this.grating;
                }
                getReadingCanvas(){
                    return this.readingCanvas;
                }
                getScreen(){
                    return this.screen;
                }
                setReadingPixelRatio(pixelRatio){
                    this.readingCanvas.setPixelRatio(pixelRatio);
                    this.readingCanvas.refreshCanvas();
                    this.readingCanvas.drawPoints(this.laser, this.grating, this.screen, this.pixelRatio);
                }
                setReadingGraphOffset(coordinates){
                    this.readingCanvas.setGraphOffSet(coordinates);
                    this.readingCanvas.refreshCanvas();
                    this.readingCanvas.drawPoints(this.laser, this.grating, this.screen, this.pixelRatio);
                }
                getCanvasContext(){
                    return this.canvas.getContext("2d");
                }
                drawGrid(){
                    var context = this.getCanvasContext();
                    var x = this.canvas.width, x0 = 0;
                    var y = this.canvas.height, y0 = 0;
                    var i = 0;
                    var cmsize = 30;
                    var mmsize = 10;
                    context.font = this.fontSize+"px Arial";
                    context.fillStyle = "red";
                    context.lineWidth = 1;
                    context.strokeStyle = "green";
                    do{
                        context.beginPath();
                        context.moveTo(x0, y);
                        context.lineTo(x0, y - cmsize);
                        context.stroke();
                        context.fillText(i, x0 + this.fontSize, y - this.fontSize);
                        if(this.pixelRatio >= 30){
                            var x00 = x0;
                            context.lineWidth = 0.6;
                            var xpx = 0;
                            for(var iterator= 1; iterator <= 9; iterator++){
                                x00 += this.pixelRatio / 10;
                                xpx = Math.floor(x00);
                                context.beginPath();
                                context.moveTo(xpx, y);
                                if(iterator % 2 == 0){
                                    context.lineTo(xpx, y - mmsize * 2);
                                }else{
                                    context.lineTo(xpx, y - mmsize);
                                }
                                context.stroke();
                            }
                            context.lineWidth = 1;
                        }
                        x0 = x0 + this.pixelRatio;
                        i++;
                    }while(x0 < x);
                    var gratingco = this.grating.getCenter();
                    var screenco = this.screen.getCenter();
                    context.beginPath();
                    context.strokeStyle = "black";
                    context.moveTo(gratingco[0], gratingco[1]);
                    context.lineTo(gratingco[0], y);
                    context.moveTo(screenco[0], screenco[1]);
                    context.lineTo(screenco[0], y);
                    context.stroke();
                }
                refreshCanvas(){
                    var context = this.getCanvasContext();
                    context.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    this.drawGrid();
                    this.laser.point(this.getCanvas(), this.grating, this.screen, this.pixelRatio);
                    this.drawGrid();
                    context.drawImage(this.laser.laserelem, this.laser.getX(), this.laser.getY());
                    context.drawImage(this.grating.gratingelem, this.grating.getX(), this.grating.getY());
                    context.drawImage(this.screen.screenelem, this.screen.getX(), this.screen.getY());
                    this.readingCanvas.refreshCanvas();
                    this.readingCanvas.drawPoints(this.laser, this.grating, this.screen, this.pixelRatio);
                }
                resetView(){
                    var context = this.getCanvasContext();
                    context.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    this.laser.resetPosition();
                    this.screen.resetPosition();
                    this.grating.resetPosition();
                    this.readingCanvas.resetView();
                    this.refreshCanvas();
                }
            }
            //This ReadingCanvas class contains all the Reading Canvas Elements related functions such as movement functions, control functions,.
            //Variables: canvas element, canvas name, canvas pixel ratio(1cm = pixelRatio);
            //Functions: drawGrid, drawPoints, getCanvasContext, refreshCanvas, resetView.
            class ReadingCanvas{
                constructor(canvas, canvasId, width, height, pixelRatio){
                    this.canvas = canvas;
                    this.canvasId = canvasId;
                    this.canvas.width = Math.floor(window.innerWidth * width * 0.98);
                    this.canvas.height = Math.floor(window.innerHeight * height * 0.98);
                    this.pixelRatio = pixelRatio;
                    this.fontSize = pixelRatio * 0.8;
                    this.graphOffSetX = 0;
                    this.graphOffSetY = 0;
                    this.zerothPointX = 4;
                    this.zerothPointY = 10;
                }
                setPixelRatio(pixelRatio){
                    this.pixelRatio = parseInt(pixelRatio);
                    this.fontSize = pixelRatio * 0.8;
                }
                drawGrid(){
                    var context = this.getCanvasContext();
                    var x = this.canvas.width, x0 = 0;
                    var y = this.canvas.height, y0 = 0;
                    var i = this.graphOffSetX + 1;
                    context.font = this.fontSize+"px Arial";
                    context.fillStyle = "red";
                    context.lineWidth = 1;
                    context.strokeStyle = "green";
                    do{
                        context.beginPath();
                        context.moveTo(x0, y);
                        context.lineTo(x0, y0);
                        context.stroke();
                        context.fillText(i, x0 + this.fontSize, y - this.fontSize);
                        if(this.pixelRatio >= 30){
                            var x00 = x0;
                            context.lineWidth = 0.5;
                            var xpx = 0;
                            for(var iterator= 0; iterator < 9; iterator++){
                                x00 += this.pixelRatio / 10;
                                xpx = Math.floor(x00);
                                context.beginPath();
                                context.moveTo(xpx, y);
                                context.lineTo(xpx, y0);
                                context.stroke();
                            }
                            context.lineWidth = 1;
                        }
                        x0 = x0 + this.pixelRatio;
                        i++;
                    }while(x0 < x);
                    x0 = 0;
                    i = this.graphOffSetY + 1;
                    do{
                        context.beginPath();
                        context.moveTo(x0, y);
                        context.lineTo(x, y);
                        context.stroke();
                        context.fillText(i, x0 + this.fontSize, y - this.fontSize);
                        if(this.pixelRatio >= 30){
                            var y00 = y;
                            context.lineWidth = 0.5;
                            var ypx = 0;
                            for(var iterator= 0; iterator < 9; iterator++){
                                y00 += this.pixelRatio / 10;
                                ypx = Math.floor(y00);
                                context.beginPath();
                                context.moveTo(x0, y00);
                                context.lineTo(x, y00);
                                context.stroke();
                            }
                            context.lineWidth = 1;
                        }
                        y -= this.pixelRatio;
                        i++;
                    }while(y > y0);
                }
                setGraphOffSet(coordinates){
                    this.graphOffSetX += coordinates[0];
                    this.graphOffSetY += coordinates[1];
                    this.refreshCanvas();
                }
                resetGraphOffSet(coordinates){
                    this.graphOffSetX = coordinates[0];
                    this.graphOffSetY = coordinates[1];
                }
                getCanvasContext(){
                    return this.canvas.getContext("2d");
                }
                drawPoints(plaser, pgrating, pscreen, pixelRatio){
                    if(plaser.getLaserState()){
                        var radius = 8;
                        var originX = 0;
                        var originY = this.canvas.height;
                        var gratingco = pgrating.getCenter();
                        var screenco = pscreen.getCenter();
                        var dist_x = (screenco[0] - gratingco[0]) / pixelRatio;
                        var context = this.getCanvasContext();
                        var pointX = originX + (this.zerothPointX - this.graphOffSetX) * this.pixelRatio;
                        var pointY = originY + (this.graphOffSetY - this.zerothPointY) * this.pixelRatio;
                        context.beginPath();
                        context.arc(pointX, pointY, radius, 0, 2 * Math.PI, false);
                        context.strokeStyle = "red";
                        context.fillStyle = "red";
                        context.fill();
                        context.stroke();
                        //radius = 4;
                        if(pgrating.getNumberOfLines() > 0){
                            var wavelength = plaser.getWavelength();
                            var N = pgrating.getNumberOfLines();
                            var angle = wavelength * N;
                            var angle = N * wavelength * Math.pow(10, -8);
                            var x = (screenco[0] - gratingco[0]) / pixelRatio;
                            for(var n = 1; n < 100; n++){
                                radius = radius - (100 - n)*0.015;
                                var N = pgrating.getNumberOfLines();
                                var arcAngle = n * angle;
                                if(arcAngle > 1 || arcAngle < -1){
                                    break;
                                }
                                var arcInverseSine = Math.asin(arcAngle);
                                var aisTan = Math.tan(arcInverseSine);
                                var y = aisTan * x;
                                if(y > 17){
                                    break;
                                }
                                pointY = originY + (this.graphOffSetY - this.zerothPointY) * this.pixelRatio;
                                var pvup = originY + (this.graphOffSetY - (this.zerothPointY + y)) * this.pixelRatio;
                                var pvdown = originY + (this.graphOffSetY - (this.zerothPointY - y)) * this.pixelRatio;
                                context.beginPath();
                                context.moveTo(pointX, pvup);
                                context.arc(pointX, pvup, radius, 0, 2 * Math.PI, false);
                                context.moveTo(pointX, pvdown);
                                context.arc(pointX, pvdown, radius, 0, 2 * Math.PI, false);
                                context.strokeStyle = "red";
                                context.fillStyle = "red";
                                context.fill();
                                context.stroke();
                                
                            }
                        }
                    }
                }
                refreshCanvas(){
                    var context = this.getCanvasContext();
                    context.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    this.drawGrid();
                }
                resetView(){
                    var context = this.getCanvasContext();
                    context.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    this.resetGraphOffSet([0, 0]);
                    this.refreshCanvas();
                }
            }
            function begin(){
                var laserelem = document.getElementById("img_laser");
                var glaser = new Laser(laserelem, 6328);
                var gratingelem = document.getElementById("img_grating");
                var ggrating = new Grating(gratingelem, [0, 0]);
                var screenelem = document.getElementById("img_screen");
                var gscreen = new Screen(screenelem, [0, 0]);
                var canvasdiv = document.getElementById("mainCanvas");
                var readingcanvasdiv = document.getElementById("readingCanvas");
                var canvas_dimensions = [0.5, 0.6, 30];
                var reading_canvas_dimensions = [0.5, 0.6, 30];
                var greadingCanvas = new ReadingCanvas(readingcanvasdiv, "readingCanvas", reading_canvas_dimensions[0], reading_canvas_dimensions[1], reading_canvas_dimensions[2]);
                
                gcanvas = new Canvas(canvasdiv, "mainCanvas", glaser, ggrating, gscreen, canvas_dimensions[0], canvas_dimensions[1], canvas_dimensions[2], greadingCanvas); 
                document.getElementById("pixelRatio").value = reading_canvas_dimensions[2];
                gcanvas.refreshCanvas();
                readings = new Readings();
                setpointNumber();
                alert("Instructions\n1. If the screen is empty, click on refresh view button\n2. Click on laser switch to turn the laser on, you will see a bright spot at the center of the graph, this is the center spot of light\n3. Select number of lines on the grating\n4. Click on take readings button\n5. Adjust the graph using canvas panel and input X coordinate and Y coordinate of any 3 adjacent points\n6. Calculate the results");
                popupquestions = new PopUpQuestion();
                popupquestions.pushQuestion(new Question("The position of grating with respect to the source changes the pattern.", ["true", "false"], 1));
                popupquestions.pushQuestion(new Question("The position of grating with respect to the source changes the pattern.", ["true", "false"], 1));
            }
            function refreshView(){
                gcanvas.refreshCanvas();
            }
            function resetView(){
                gcanvas.resetView();
            }
            function numberOfLinesChanged(){
                var ggrating = gcanvas.getGrating();
                var numberOfLines = parseInt(document.getElementById("numberOfLines").value);
                if(!ggrating.setNumberOfLines(numberOfLines)){
                    document.getElementById("numberOfLines").options.selectedIndex = 0;
                    ggrating.setNumberOfLines(0);
                }
                gcanvas.refreshCanvas();
            }
            function laserButtonClicked(){
                var glaser = gcanvas.getLaser();
                glaser.flipLaserState();
                if(glaser.getLaserState()){
                    document.getElementById("laserButton").style.background = "#ff0";
                }else{
                    document.getElementById("laserButton").style.background = "#000";
                }
                gcanvas.refreshCanvas();
            }
            function changeLaserPosition(diff){
                gcanvas.moveElements([diff, 0], [0, 0], [0, 0]);
            }
            function changeGratingPosition(diff){
                gcanvas.moveElements([0, 0], [diff, 0], [0, 0]);
            }
            function changeScreenPosition(diff){
                gcanvas.moveElements([0, 0], [0, 0], [diff, 0]);
            }
            function moveToNext(){
                window.location.href = "simulator_readings.html";
            }
            function pixelRatioChanged(){
                var pixelRatio = document.getElementById("pixelRatio").value;
                var readingCanvas = gcanvas.setReadingPixelRatio(pixelRatio);
            }
            function graphMovementButtonClicked(x, y){
                gcanvas.setReadingGraphOffset([x, y]);
                
            }
            function showReadingsForm(){
                document.getElementById("takeReadingsButton").style.display = "none";
                document.getElementById("readingForm").style.display = "block";
                alert("In the readings form, there are three input boxes, out of which, the first is prefilled and shows the point number. To take readings, you will have to enter the X and Y coordinates of the nth point, in the below two boxes. note: the point number must be measured from the center brightest point.");
            }
            function setpointNumber(){
                var pointNumber = readings.getpointNumber();
                document.getElementById("pointNumber").value = "Point " + pointNumber;
            }
            function pointReadingsChanged(){
                var pointX = parseFloat(document.getElementById("pointX").value);
                var pointY = parseFloat(document.getElementById("pointY").value);
                
                if(isNaN(pointX) || isNaN(pointY)){
                    alert("Please Enter The Values");
                    return;
                }
                document.getElementById("pointX").value = null;
                document.getElementById("pointY").value = null;
                if(readings.setNewReadings([pointX, pointY])){
                    var pgrating = gcanvas.getGrating();
                    var numberOfLines = pgrating.getNumberOfLines();
                    var plaser = gcanvas.getLaser();
                    var actualWavelength = plaser.getWavelength();
                    readings.calculateResult(numberOfLines, actualWavelength);
                    window.location.href = "observations.html";
                }else{
                    setpointNumber();
                }
            }
            function questionManager(){
                if(popupquestions.popUpCounterSet()){
                    if(popupquestions.count()){
                        var question = popupquestions.popQuestion();
                        var questionstring = question.getQuestion();
                        var options = question.getOptions();
                        questionstring += "(Enter Correct Option)";
                        for(var i = 1; i <= options.length; i++){
                            questionstring += "\n" + i + ". " + options[i - 1];
                        }
                        var choice = parseInt(prompt(questionstring));
                        while(choice != question.getCorrectOption() + 1){
                            alert("Incorrect");
                            var choice = parseInt(prompt(questionstring));
                        }
                        alert("correct");
                    }
                }else{
                    if(!popupquestions.questionUnderFlow()){
                        popupquestions.setPopUpCounter(10);
                    }
                    
                }
            }
            window.addEventListener('load', begin, false );
            window.addEventListener('keypress', questionManager, false);
            window.addEventListener('click', questionManager, false);
        </script>
	</body>
</html>